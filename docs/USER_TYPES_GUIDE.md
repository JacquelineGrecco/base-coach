# User Types System - Guide

## ğŸ¯ Overview

BaseCoach now supports two types of users:
- **ğŸ† Coaches (Treinadores):** Manage teams, evaluate players, and generate reports
- **âš½ Players (Atletas):** Athletes being evaluated (future feature)

Currently, the app is designed exclusively for **coaches**, but the database and authentication system are now prepared for future player features.

---

## ğŸ—„ï¸ Database Schema Changes

### New Column: `user_type`

Added to the `users` table:

```sql
user_type TEXT CHECK (user_type IN ('coach', 'player')) DEFAULT 'coach'
```

**Properties:**
- **Values:** `'coach'` or `'player'`
- **Default:** `'coach'`
- **Indexed:** Yes (for faster queries)
- **Required:** Yes

---

## ğŸ“ Files Modified

### 1. **Migration: `006_add_user_type_to_users.sql`**
- Adds `user_type` column
- Updates existing users to `'coach'`
- Modifies `handle_new_user()` trigger to accept user type from signup metadata

### 2. **Services: `userService.ts`**
- Added `UserType` type: `'coach' | 'player'`
- Added `PlanType` type: `'free' | 'basic' | 'premium'`
- Updated `UserProfile` interface to include `user_type`
- Updated `updateProfile()` to support user type changes

### 3. **Services: `authService.ts`**
- Updated `signUp()` to accept optional `userType` parameter
- Defaults to `'coach'` if not specified
- Stores user type in auth metadata

### 4. **Context: `AuthContext.tsx`**
- Updated `signUp` function signature to include `userType`
- Defaults to `'coach'` for backward compatibility

### 5. **Components: `Profile.tsx`**
- Shows user type badge (ğŸ† Treinador or âš½ Atleta)
- Consolidated delete account section into Personal Information tab
- Removed separate "Account" tab

---

## ğŸš€ How to Use

### Run the Migration

**Step 1:** Go to [Supabase Dashboard](https://app.supabase.com)

**Step 2:** Open SQL Editor and run:

```sql
-- Add user_type column to differentiate between coaches and players
ALTER TABLE users 
ADD COLUMN IF NOT EXISTS user_type TEXT 
CHECK (user_type IN ('coach', 'player'))
DEFAULT 'coach';

-- Create index for faster user type queries
CREATE INDEX IF NOT EXISTS idx_users_user_type ON users(user_type);

-- Update existing users to be 'coach' type
UPDATE users 
SET user_type = 'coach' 
WHERE user_type IS NULL;

-- Update the handle_new_user function to set user_type from metadata
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.users (id, email, name, user_type, created_at, updated_at)
  VALUES (
    NEW.id,
    NEW.email,
    COALESCE(NEW.raw_user_meta_data->>'name', 'New User'),
    COALESCE(NEW.raw_user_meta_data->>'user_type', 'coach'),
    NOW(),
    NOW()
  );
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

---

## ğŸ‘¥ User Type Behavior

### Coach Users (Current Implementation)
- âœ… Can create and manage teams
- âœ… Can add players to teams
- âœ… Can run evaluation sessions
- âœ… Can generate reports
- âœ… Can manage subscription plans
- âœ… Full access to all coach features

### Player Users (Future Feature)
- ğŸ”œ View their own evaluation history
- ğŸ”œ Track personal progress over time
- ğŸ”œ View reports generated by coaches
- ğŸ”œ Receive notifications about sessions
- ğŸ”œ Limited interface focused on personal stats

---

## ğŸ¨ UI Changes

### Profile Page - Before & After

**Before:**
- 3 tabs: Personal Info | Plan | Account
- Delete account in separate tab

**After:**
- 2 tabs: Personal Info | Plan
- Delete account at bottom of Personal Info tab
- User type badge displayed in header (ğŸ† Treinador)

### Visual Improvements
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ConfiguraÃ§Ãµes  ğŸ† Treinador             â”‚
â”‚ Gerencie seu perfil e preferÃªncias      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [InformaÃ§Ãµes Pessoais] [Plano]          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                          â”‚
â”‚  Personal Info Form                      â”‚
â”‚                                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                 â”‚
â”‚                                          â”‚
â”‚  Change Password Section                 â”‚
â”‚                                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                 â”‚
â”‚                                          â”‚
â”‚  ğŸ—‘ï¸ Delete Account Section              â”‚
â”‚  (With warning and confirmation)         â”‚
â”‚                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”’ Security Considerations

### Row Level Security (RLS)
- Each user type will have specific RLS policies
- Coaches can only see their own teams and players
- Players can only see their own evaluation data
- User type is immutable after account creation (requires admin to change)

### Data Isolation
```sql
-- Example RLS policy for coaches only
CREATE POLICY "Coaches can manage their teams" ON teams
  FOR ALL
  USING (
    user_id = auth.uid() AND
    EXISTS (
      SELECT 1 FROM users 
      WHERE id = auth.uid() 
      AND user_type = 'coach'
    )
  );
```

---

## ğŸ“Š Database Structure

```
auth.users (Supabase System)
  â”œâ”€â”€ id
  â”œâ”€â”€ email
  â”œâ”€â”€ raw_user_meta_data
  â”‚   â”œâ”€â”€ name
  â”‚   â””â”€â”€ user_type  â† stored here during signup
  â””â”€â”€ ...

public.users (Your Table)
  â”œâ”€â”€ id
  â”œâ”€â”€ email
  â”œâ”€â”€ name
  â”œâ”€â”€ phone
  â”œâ”€â”€ user_type     â† 'coach' or 'player'
  â”œâ”€â”€ plan_type     â† 'free', 'basic', or 'premium'
  â”œâ”€â”€ created_at
  â””â”€â”€ updated_at
```

---

## ğŸ§ª Testing

### Test Coach Signup
```typescript
// Default behavior (creates coach)
await authService.signUp('coach@example.com', 'password123', 'Coach Name');

// Explicit coach signup
await authService.signUp('coach@example.com', 'password123', 'Coach Name', 'coach');
```

### Test Player Signup (Future)
```typescript
// Player signup
await authService.signUp('player@example.com', 'password123', 'Player Name', 'player');
```

### Verify User Type
```sql
-- Check user types in database
SELECT id, email, name, user_type, plan_type 
FROM users 
ORDER BY created_at DESC;
```

---

## ğŸ”® Future Enhancements

### Player Portal (v2.0+)
1. **Player Dashboard**
   - Personal stats overview
   - Recent evaluations
   - Progress charts

2. **Reports Access**
   - View reports shared by coaches
   - Download premium reports (if parent purchased)

3. **Notifications**
   - Session reminders
   - New evaluation alerts
   - Report availability

### Admin Panel (v3.0+)
- Change user types
- Merge duplicate accounts
- View user analytics by type

---

## ğŸ› Troubleshooting

### "user_type cannot be null" error
**Solution:** Run migration `006_add_user_type_to_users.sql`

### User type not showing in Profile
**Solution:** Clear cache and reload. Check if migration ran successfully.

### Cannot change user type
**Solution:** By design. Contact admin or create new account with correct type.

---

## ğŸ“š API Reference

### TypeScript Types

```typescript
// User type enum
export type UserType = 'coach' | 'player';

// Plan type enum
export type PlanType = 'free' | 'basic' | 'premium';

// User profile interface
export interface UserProfile {
  id: string;
  email: string;
  name: string;
  phone?: string;
  user_type: UserType;
  plan_type?: PlanType;
  created_at: string;
  updated_at: string;
}
```

### Service Methods

```typescript
// Sign up with user type
authService.signUp(
  email: string, 
  password: string, 
  name: string, 
  userType?: 'coach' | 'player'
): Promise<{ user: User | null; error: Error | null }>

// Get user profile
userService.getUserProfile(
  userId: string
): Promise<{ profile: UserProfile | null; error: Error | null }>

// Update profile (including user_type if needed)
userService.updateProfile(
  userId: string,
  updates: { 
    name?: string; 
    phone?: string; 
    email?: string; 
    user_type?: UserType 
  }
): Promise<{ error: Error | null }>
```

---

## âœ… Migration Checklist

- [ ] Run migration `005_add_plan_type_to_users.sql`
- [ ] Run migration `006_add_user_type_to_users.sql`
- [ ] Verify column exists: `SELECT user_type FROM users LIMIT 1;`
- [ ] Test signup with default (coach) user type
- [ ] Check Profile page shows user type badge
- [ ] Verify all existing users have `user_type = 'coach'`

---

**Created:** December 7, 2025  
**Status:** âœ… Implemented  
**Current User Type:** Coach only  
**Future Support:** Player accounts (v2.0+)

